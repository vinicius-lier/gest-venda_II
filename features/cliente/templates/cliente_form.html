{% extends 'shared/templates/base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.id %}Editar Cliente{% else %}Novo Cliente{% endif %} - Gestão Operacional{% endblock %}

{% block extra_css %}
<style>
    .required-field label:after {
        content: " *";
        color: var(--danger-color);
    }
    
    .form-section {
        margin-bottom: 30px;
    }
    
    .form-section-title {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f9f9f9;
        color: var(--dark-color);
    }
    
    .card-header-tabs {
        margin-left: -1.25rem;
        margin-right: -1.25rem;
        margin-bottom: -1.25rem;
    }
    
    .info-box {
        padding: 15px;
        background-color: rgba(0, 107, 230, 0.1);
        border-radius: 3px;
        margin-bottom: 20px;
    }
    
    .info-box p:last-child {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="h3 mb-2">
            {% if form.instance.id %}
                Editar Cliente
            {% else %}
                Novo Cliente
            {% endif %}
        </h1>
        <p class="text-muted mb-4">
            {% if form.instance.id %}
                Atualize as informações do cliente.
            {% else %}
                Preencha os dados para cadastrar um novo cliente.
            {% endif %}
        </p>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>Dados do Cliente</h4>
                
                {% if form.instance.id %}
                <div class="card-header-action">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="clienteAcoes" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog"></i> Ações
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="clienteAcoes">
                            <li>
                                <a class="dropdown-item" href="{% url 'core:cliente_detail' form.instance.id %}">
                                    <i class="fas fa-eye me-2"></i> Ver Detalhes
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="{% url 'core:cliente_delete' form.instance.id %}" data-confirm="Tem certeza que deseja excluir este cliente?">
                                    <i class="fas fa-trash me-2"></i> Excluir
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="clienteForm">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i> Por favor, corrija os erros abaixo.
                    </div>
                    {% endif %}
                    
                    <!-- Dados Pessoais -->
                    <div class="form-section">
                        <h5 class="form-section-title">Dados Pessoais</h5>
                        <div class="row">
                            <div class="col-md-6 required-field">
                                {{ form.nome|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.cpf|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.rg|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.endereco|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.telefone|as_crispy_field }}
                            </div>
                            <div class="col-md-3">
                                {{ form.email|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dados Complementares -->
                    <div class="form-section">
                        <h5 class="form-section-title">Dados Complementares</h5>
                        <div class="row">
                            <div class="col-md-4">
                                {{ form.tipo|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.data_cadastro|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.motos|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                {{ form.observacoes|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botões -->
                    <div class="form-group">
                        <a href="{% url 'core:cliente_list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i> Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if form.instance.id %}
<!-- Histórico de Compras -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>Histórico de Compras</h4>
            </div>
            <div class="card-body">
                {% if compras %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Moto</th>
                                <th>Data</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for venda in compras %}
                            <tr>
                                <td>{{ venda.moto.marca }} {{ venda.moto.modelo }}</td>
                                <td>{{ venda.data_venda|date:"d/m/Y" }}</td>
                                <td>R$ {{ venda.valor_venda }}</td>
                                <td>
                                    <span class="badge bg-success">{{ venda.status }}</span>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'core:venda_detail' venda.id %}" class="btn btn-sm btn-icon btn-info" data-bs-toggle="tooltip" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-3">
                    <p class="text-muted mb-0">Nenhuma compra registrada para este cliente.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Motos do Cliente -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>Motos do Cliente</h4>
            </div>
            <div class="card-body">
                {% if motos_cliente %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Marca/Modelo</th>
                                <th>Ano</th>
                                <th>Placa</th>
                                <th>Chassi</th>
                                <th>Status</th>
                                <th class="text-center">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for moto in motos_cliente %}
                            <tr>
                                <td>{{ moto.marca }} {{ moto.modelo }}</td>
                                <td>{{ moto.ano }}</td>
                                <td>{{ moto.placa|default:"-" }}</td>
                                <td>{{ moto.chassi|default:"-" }}</td>
                                <td>
                                    <span class="badge {% if moto.status == 'DISPONIVEL' %}bg-success{% else %}bg-warning{% endif %}">
                                        {{ moto.status }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'core:estoque_moto_detail' moto.id %}" class="btn btn-sm btn-icon btn-info" data-bs-toggle="tooltip" title="Ver Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center p-3">
                    <p class="text-muted mb-0">Nenhuma moto registrada para este cliente.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de Cadastro Rápido de Moto -->
<div class="modal fade" id="modalNovaMoto" tabindex="-1" aria-labelledby="modalNovaMotoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNovaMotoLabel">Cadastro Rápido de Moto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNovaMoto">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="novoMotoMarca" class="form-label">Marca *</label>
                            <input type="text" class="form-control" id="novoMotoMarca" name="novoMotoMarca" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="novoMotoModelo" class="form-label">Modelo *</label>
                            <input type="text" class="form-control" id="novoMotoModelo" name="novoMotoModelo" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="novoMotoAno" class="form-label">Ano *</label>
                            <input type="text" class="form-control" id="novoMotoAno" name="novoMotoAno" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="novoMotoCor" class="form-label">Cor *</label>
                            <input type="text" class="form-control" id="novoMotoCor" name="novoMotoCor" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="novoMotoPlaca" class="form-label">Placa</label>
                            <input type="text" class="form-control" id="novoMotoPlaca" name="novoMotoPlaca">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="novoMotoValor" class="form-label">Valor *</label>
                            <input type="text" class="form-control currency-input" id="novoMotoValor" name="novoMotoValor" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarNovaMoto">
                    <i class="fas fa-save me-1"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuração dos campos
    setupCPFField();
    setupTelefoneField();
    setupMotoField();
    
    // Valida formulário antes de enviar
    document.getElementById('clienteForm').addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
        }
    });
});

// Configuração do campo CPF
function setupCPFField() {
    const cpfInput = document.getElementById('id_cpf');
    if (!cpfInput) return;
    
    cpfInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        
        if (value.length > 11) {
            value = value.substr(0, 11);
        }
        
        if (value.length > 9) {
            value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{1,2})$/, "$1.$2.$3-$4");
        } else if (value.length > 6) {
            value = value.replace(/^(\d{3})(\d{3})(\d{1,3})$/, "$1.$2.$3");
        } else if (value.length > 3) {
            value = value.replace(/^(\d{3})(\d{1,3})$/, "$1.$2");
        }
        
        this.value = value;
    });
    
    cpfInput.addEventListener('blur', function() {
        if (this.value && !validateCPF(this.value)) {
            // Adiciona classe de erro e mensagem
            this.classList.add('is-invalid');
            
            let feedback = this.parentNode.querySelector('.invalid-feedback');
            if (!feedback) {
                feedback = document.createElement('div');
                feedback.className = 'invalid-feedback';
                this.parentNode.appendChild(feedback);
            }
            
            feedback.textContent = 'CPF inválido';
        } else {
            // Remove erro
            this.classList.remove('is-invalid');
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            if (feedback) {
                feedback.remove();
            }
        }
    });
}

// Configuração do campo Telefone
function setupTelefoneField() {
    const telInput = document.getElementById('id_telefone');
    if (!telInput) return;
    
    telInput.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        
        if (value.length > 11) {
            value = value.substr(0, 11);
        }
        
        if (value.length > 10) {
            value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3");
        } else if (value.length > 6) {
            value = value.replace(/^(\d{2})(\d{4})(\d{1,4})$/, "($1) $2-$3");
        } else if (value.length > 2) {
            value = value.replace(/^(\d{2})(\d{1,4})$/, "($1) $2");
        }
        
        this.value = value;
    });
}

// Configuração do campo Moto
function setupMotoField() {
    const motoSelect = document.getElementById('id_motos');
    if (!motoSelect) return;
    
    // Adiciona botão para cadastro rápido
    const helpText = motoSelect.nextElementSibling;
    if (helpText && helpText.classList.contains('form-text')) {
        helpText.innerHTML += ' <button type="button" class="btn btn-sm btn-outline-primary" id="btnNovaMoto"><i class="fas fa-plus-circle"></i> Nova Moto</button>';
        
        // Configura evento de clique
        document.getElementById('btnNovaMoto').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Abre modal de cadastro rápido
            const modal = new bootstrap.Modal(document.getElementById('modalNovaMoto'));
            modal.show();
        });
    }
}

// Validação do CPF
function validateCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    
    if (cpf.length !== 11) {
        return false;
    }
    
    // Verifica CPFs com todos os dígitos iguais
    if (/^(\d)\1{10}$/.test(cpf)) {
        return false;
    }
    
    // Validação do primeiro dígito verificador
    let sum = 0;
    for (let i = 0; i < 9; i++) {
        sum += parseInt(cpf.charAt(i)) * (10 - i);
    }
    let rest = 11 - (sum % 11);
    if (rest === 10 || rest === 11) {
        rest = 0;
    }
    if (rest !== parseInt(cpf.charAt(9))) {
        return false;
    }
    
    // Validação do segundo dígito verificador
    sum = 0;
    for (let i = 0; i < 10; i++) {
        sum += parseInt(cpf.charAt(i)) * (11 - i);
    }
    rest = 11 - (sum % 11);
    if (rest === 10 || rest === 11) {
        rest = 0;
    }
    if (rest !== parseInt(cpf.charAt(10))) {
        return false;
    }
    
    return true;
}

// Validação do formulário
function validateForm() {
    let isValid = true;
    
    // Valida campo Nome (obrigatório)
    const nomeInput = document.getElementById('id_nome');
    if (!nomeInput.value.trim()) {
        nomeInput.classList.add('is-invalid');
        let feedback = nomeInput.parentNode.querySelector('.invalid-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            nomeInput.parentNode.appendChild(feedback);
        }
        feedback.textContent = 'Nome é obrigatório';
        isValid = false;
    }
    
    // Valida CPF se preenchido
    const cpfInput = document.getElementById('id_cpf');
    if (cpfInput.value.trim() && !validateCPF(cpfInput.value)) {
        cpfInput.classList.add('is-invalid');
        let feedback = cpfInput.parentNode.querySelector('.invalid-feedback');
        if (!feedback) {
            feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            cpfInput.parentNode.appendChild(feedback);
        }
        feedback.textContent = 'CPF inválido';
        isValid = false;
    }
    
    return isValid;
}
</script>
{% endblock %} 